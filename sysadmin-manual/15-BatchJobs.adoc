
:imagesdir: images

== Batch Jobs

The _Batch Jobs_ page allows a system administrator to monitor batch jobs executed in Niord.

image::BatchJobsPage.png[Batch Jobs Page, 800]

Batch jobs play an extremely important role in Niord. Almost all types of Niord data, e.g. areas,
charts, categories, dictionaries, messages, etc., can be imported using batch jobs.

The list in the left side of the _Batch Jobs_ page, lists all the batch job types that have been executed
in Niord, and for each batch job type, the number of executions.

=== Batch Job Execution

Batch Jobs can either be executed from the UI (e.g. by uploading an AtoN Excel file from
Danish <<Integration>> sysadmin page), or by copying the same file to a batch job folder on the Niord server.

The path to the batch job file system folder is: _$NIORD_HOME/batch-jobs/batch-job-type/in_.
The screenshot below shows the batch job folder structure, with the folders of the "dk-aton-import"
batch job fully expanded:

image::BatchJobFolders.png[Batch Job Folders, 300]

When the batch job is executed, the batch job file is copied to the "execution" sub-folder with the format
_$NIORD_HOME/batch-jobs/batch-job-type/execution/year/month/execution-no_, along with the log files
produced whilst executing the batch job.

The batch job architecture in Niord is implemented using the Java EE 7.0 Batch Processing Architecture
- please refer
to http://www.oracle.com/technetwork/articles/java/batch-1965499.html.
This means that the batch jobs are typically divided into three sub-tasks for _reading_, _processing_ and
_writing_ data, each producing their own log file in the execution folder.

Also, each batch job processes a certain batch job-specific number of records in each transaction, which
means that the batch job can be stopped during execution, restarted or abandoned.

As an example, the "dk-aton-import", which is a fairly long-running batch job, will first
have the "started" status, and appear with a progress indicator on the _Batch Jobs_ page:

image::BatchJobRunning.png[Batch Jobs Running, 800]

If the batch job fails during execution, if will stop executing, and enter the "failed" status.
Similarly, if the user clicks the "Stop" button, it will enter the "stopped" status:

image::BatchJobRestart.png[Batch Jobs Stopped, 800]

All database transactions will be rolled back to the last successful commit before the batch job failed
or was stopped.
The system administrator can now click the "Abandon" button to completely abandon the batch job, or
she can click "Restart" to attempt to restart the batch job. If the batch job failed, the
sysadmin may e.g. attempt to update the batch job file to fix the problem causing it to fail,
and then restart.

The sysadmin can also inspect the log files generated by the sub-tasks of the batch job, by clicking
the "logs..." link, which opens the _Batch Job Logs_ dialog:

image::BatchJobLogDialog.png[Batch Jobs Log Files, 300]

All associated log files are listed in the top part of the dialog, and the contents of a log file
can be inspected by clicking on the associated log file name.

=== Batch Sets

The "Upload Batch Set" button in the top-right part of the _Batch Jobs_ page, allows the system
administrator to upload a zip-archive containing multiple batch job files.

The zip archive must also contain a special file, _batch-set.json_, which enlists and schedules
all included batch jobs.

Example:
[source,json]
----
[
  {
    "jobName": "domain-import",
    "fileName": "domains.json",
    "delay": 2000
  },
  {
    "jobName": "dictionary-import",
    "fileName": "aton-dict.json",
    "delay": 2100
  },
  {
    "jobName": "chart-import",
    "fileName": "charts.json",
    "delay": 5000
  },
  {
    "jobName": "area-import",
    "fileName": "areas.json",
    "delay": 5100
  },
  ...
]
----

The scheduling mechanism (i.e. the "delay" attribute), can be used for handling inter-dependencies
between imported data. If e.g. the areas.json file depends on the presence of the domains defined in
the domains.json file, they can be scheduled as seen in the example above.

=== Batch Job Clean-Up

In order to avoid getting the Niord file system filled up with batch job execution files and folders,
old files and folders will automatically be deleted after a certain amount of time, as dictated
by the "batchFileExpiryDays" system setting.
